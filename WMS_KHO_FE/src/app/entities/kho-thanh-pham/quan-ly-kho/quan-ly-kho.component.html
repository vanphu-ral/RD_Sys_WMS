<div class="nhapkho-container">
    <div class="nhapkho-header">
        <div class="header-title">
            <mat-icon class="title-icon">inventory</mat-icon>
            <div>
                <h1>Quản lý kho</h1>
                <p class="subtitle">Warehouse materials management</p>
            </div>
        </div>
    </div>

    <!-- Content Card -->
    <mat-card class="nhapkho-card">
        <!-- Table Header -->
        <div class="table-header">
            <div class="table-title">
                <mat-icon>list</mat-icon>
                <span>Danh sách</span>
            </div>
            <div class="table-actions">
                <button mat-raised-button color="primary" class="action-header-btn" (click)="onCheckWarehouse()">
                    <mat-icon>search</mat-icon>
                    Kiểm tra
                </button>
                <button mat-raised-button color="primary" class="action-header-btn" (click)="onUpdateInventory()">
                    <mat-icon>update</mat-icon>
                    Cập nhật tồn
                </button>
                <button mat-raised-button color="primary" class="action-header-btn" (click)="onTransferWarehouse()">
                    <mat-icon>sync_alt</mat-icon>
                    Chuyển vị trí
                </button>
                <div class="dropdown-group">
                    <button mat-raised-button [matMenuTriggerFor]="viewMenu" class="dropdown-btn">
                        Mode view
                        <mat-icon>arrow_drop_down</mat-icon>
                    </button>

                    <mat-menu #viewMenu="matMenu">
                        <button mat-menu-item (click)="onSelectView('area')">
                            <mat-icon>location_on</mat-icon>
                            <span>View theo Kho</span>
                        </button>
                        <button mat-menu-item (click)="onSelectView('po')">
                            <mat-icon>assignment</mat-icon>
                            <span>View theo PO</span>
                        </button>
                        <button mat-menu-item (click)="onSelectView('customer')">
                            <mat-icon>person</mat-icon>
                            <span>View theo khách hàng</span>
                        </button>
                        <button mat-menu-item (click)="onSelectView('product')">
                            <mat-icon>category</mat-icon>
                            <span>View theo Mã sản phẩm</span>
                        </button>
                    </mat-menu>
                    <button mat-raised-button [matMenuTriggerFor]="columnMenu" class="dropdown-btn">
                        View column
                        <mat-icon>arrow_drop_down</mat-icon>
                    </button>

                    <mat-menu #columnMenu="matMenu">
                        <div class="column-menu" (click)="$event.stopPropagation()"
                            style="padding: 12px; max-width: 320px;">
                            <!-- Default view columns -->
                            <ng-container *ngIf="currentViewMode === 'default'">
                                <div class="group-title">Mặc định</div>
                                <mat-checkbox *ngFor="let col of viewColumns.default" [(ngModel)]="col.visible"
                                    (change)="onColumnVisibilityChange('default')">
                                    {{ col.label }}
                                </mat-checkbox>
                            </ng-container>

                            <!-- PO grouped view: parent + child -->
                            <ng-container *ngIf="currentViewMode === 'po'">
                                <div class="group-title">PO - Cha</div>
                                <mat-checkbox *ngFor="let col of viewColumns.poParent" [(ngModel)]="col.visible"
                                    (change)="onColumnVisibilityChange('poParent')">
                                    {{ col.label }}
                                </mat-checkbox>

                                <mat-divider></mat-divider>

                                <div class="group-title">PO - Con</div>
                                <mat-checkbox *ngFor="let col of viewColumns.poChild" [(ngModel)]="col.visible"
                                    (change)="onColumnVisibilityChange('poChild')">
                                    {{ col.label }}
                                </mat-checkbox>
                            </ng-container>

                            <!-- Product grouped view -->
                            <ng-container *ngIf="currentViewMode === 'product'">
                                <div class="group-title">Sản phẩm - Cha</div>
                                <mat-checkbox *ngFor="let col of viewColumns.productParent" [(ngModel)]="col.visible"
                                    (change)="onColumnVisibilityChange('productParent')">
                                    {{ col.label }}
                                </mat-checkbox>

                                <mat-divider></mat-divider>

                                <div class="group-title">Sản phẩm - Con</div>
                                <mat-checkbox *ngFor="let col of viewColumns.productChild" [(ngModel)]="col.visible"
                                    (change)="onColumnVisibilityChange('productChild')">
                                    {{ col.label }}
                                </mat-checkbox>
                            </ng-container>

                            <!-- Area grouped view -->
                            <ng-container *ngIf="currentViewMode === 'area'">
                                <div class="group-title">Kho - Cha</div>
                                <mat-checkbox *ngFor="let col of viewColumns.areaParent" [(ngModel)]="col.visible"
                                    (change)="onColumnVisibilityChange('areaParent')">
                                    {{ col.label }}
                                </mat-checkbox>

                                <mat-divider></mat-divider>

                                <div class="group-title">Kho - Con</div>
                                <mat-checkbox *ngFor="let col of viewColumns.areaChild" [(ngModel)]="col.visible"
                                    (change)="onColumnVisibilityChange('areaChild')">
                                    {{ col.label }}
                                </mat-checkbox>
                            </ng-container>

                            <!-- Customer grouped view -->
                            <ng-container *ngIf="currentViewMode === 'customer'">
                                <div class="group-title">Khách hàng - Cha</div>
                                <mat-checkbox *ngFor="let col of viewColumns.customerParent" [(ngModel)]="col.visible"
                                    (change)="onColumnVisibilityChange('customerParent')">
                                    {{ col.label }}
                                </mat-checkbox>

                                <mat-divider></mat-divider>

                                <div class="group-title">Khách hàng - Con</div>
                                <mat-checkbox *ngFor="let col of viewColumns.customerChild" [(ngModel)]="col.visible"
                                    (change)="onColumnVisibilityChange('customerChild')">
                                    {{ col.label }}
                                </mat-checkbox>
                            </ng-container>

                            <mat-divider></mat-divider>

                            <div style="display:flex; gap:8px; margin-top:8px;">
                                <button mat-button (click)="resetColumnsForCurrentView()">Reset</button>
                                <button mat-button (click)="saveColumnPrefsForCurrentView()">Save</button>
                            </div>
                        </div>
                    </mat-menu>

                </div>
                <button mat-raised-button class="refresh-btn" matTooltip="Xuất dữ liệu" (click)="exportData()">
                    <mat-icon color="primary">ios_share</mat-icon>
                </button>

                <button mat-raised-button class="refresh-btn" matTooltip="Đồng bộ dữ liệu" (click)="refresh()">
                    <mat-icon color="primary">sync</mat-icon>
                </button>
            </div>
        </div>

        <!-- Table -->
        <div class="table-container">
            <div class="table-container">
                <table mat-table [dataSource]="warehouseList" class="warehouse-table"
                    *ngIf="currentViewMode === 'default'">
                    <ng-container
                        *ngFor="let col of (currentViewMode === 'default' ? getCurrentColumns() : getCurrentColumns('parent'))"
                        [matColumnDef]="col.key">
                        <ng-container *ngIf="col.visible">

                            <!-- Header -->
                            <th mat-header-cell *matHeaderCellDef>
                                <div class="header-content">{{ col.label }}</div>

                                <!-- Search box chỉ hiển thị cho các cột filterable -->
                                <ng-container *ngIf="col.filterable">
                                    <mat-form-field class="search-field" appearance="outline">

                                        <!-- Autocomplete cho locationCode -->
                                        <input *ngIf="col.key === 'locationCode'" matInput
                                            [(ngModel)]="filterValues['locationCode']"
                                            (ngModelChange)="onLocationFilterChange($event)"
                                            (keypress)="onFilterKeyPress($event)" [matAutocomplete]="autoLocation" />

                                        <mat-autocomplete #autoLocation="matAutocomplete"
                                            (optionSelected)="onLocationSelected($event.option.value)">
                                            <mat-option *ngFor="let loc of filteredLocations" [value]="loc.code">
                                                {{ loc.code }}
                                            </mat-option>
                                        </mat-autocomplete>

                                        <!-- Các trường khác -->
                                        <input *ngIf="col.key !== 'locationCode'" matInput
                                            [(ngModel)]="filterValues[col.key]" (keypress)="onFilterKeyPress($event)" />

                                        <button mat-icon-button matSuffix [matMenuTriggerFor]="filterModeMenu"
                                            *ngIf="col.key !== 'locationCode'">
                                            <mat-icon>keyboard_arrow_down</mat-icon>
                                        </button>

                                        <!-- Clear button cho location -->
                                        <button mat-icon-button matSuffix
                                            *ngIf="col.key === 'locationCode' && filterValues['locationCode']"
                                            (click)="filterValues['locationCode'] = ''; onLocationFilterChange(''); $event.stopPropagation()">
                                            <mat-icon>clear</mat-icon>
                                        </button>
                                    </mat-form-field>
                                </ng-container>
                            </th>

                            <!-- Cell -->
                            <td mat-cell *matCellDef="let item; let i = index">
                                <ng-container [ngSwitch]="col.key">
                                    <span *ngSwitchCase="'stt'">{{ i + 1 + (currentPage - 1) * pageSize }}</span>

                                    <ng-container *ngSwitchCase="'calculatedStatus'">
                                        <span class="status-badge" [ngClass]="getStatusClass(item.calculatedStatus)">
                                            {{ item.calculatedStatus }}
                                        </span>
                                    </ng-container>

                                    <span *ngSwitchDefault>{{ item[col.key] }}</span>
                                </ng-container>
                            </td>
                        </ng-container>
                    </ng-container>

                    <!-- Filter mode menu -->
                    <mat-menu #filterModeMenu="matMenu">
                        <button mat-menu-item (click)="setFilterMode('constraint')">
                            <span>Constraint</span>
                        </button>
                        <button mat-menu-item (click)="setFilterMode('not_constraint')">
                            <span>Not Constraint</span>
                        </button>
                    </mat-menu>

                    <!-- Header & Row -->
                    <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                    <tr mat-row *matRowDef="let row; columns: displayedColumns;" class="table-row"></tr>
                </table>
            </div>


            <!-- PO View -->
            <table mat-table [dataSource]="poDataSource" class="warehouse-table expandable-table" multiTemplateDataRows
                *ngIf="currentViewMode === 'po'">

                <!-- Duyệt qua các cột cha -->
                <ng-container *ngFor="let col of viewColumns.poParent" [matColumnDef]="col.key">
                    <th mat-header-cell *matHeaderCellDef>
                        <ng-container [ngSwitch]="col.key">
                            <!-- Cột mở rộng -->
                            <ng-container *ngSwitchCase="'expand'"></ng-container>

                            <!-- Cột PO có search -->
                            <ng-container *ngSwitchCase="'po'">
                                <div class="header-content">{{ col.label }}</div>
                                <mat-form-field class="search-field" appearance="outline">
                                    <input matInput [(ngModel)]="filterValues['po']" (keyup.enter)="applyFilter()"
                                        [matMenuTriggerFor]="filterModeMenu" />
                                    <button mat-icon-button matSuffix [matMenuTriggerFor]="filterModeMenu">
                                        <mat-icon>keyboard_arrow_down</mat-icon>
                                    </button>
                                </mat-form-field>
                            </ng-container>

                            <!-- Các cột còn lại -->
                            <ng-container *ngSwitchDefault>
                                <div class="header-content">{{ col.label }}</div>
                                <mat-form-field class="search-field" appearance="outline">
                                    <input matInput [(ngModel)]="filterValues[col.key]" (keyup.enter)="applyFilter()" />
                                </mat-form-field>
                            </ng-container>
                        </ng-container>
                    </th>

                    <td mat-cell *matCellDef="let item">
                        <ng-container [ngSwitch]="col.key">
                            <ng-container *ngSwitchCase="'expand'">
                                <button mat-icon-button (click)="toggleRow(item); $event.stopPropagation()">
                                    <mat-icon>{{ item.expanded ? 'expand_more' : 'chevron_right' }}</mat-icon>
                                </button>
                            </ng-container>

                            <ng-container *ngSwitchCase="'po'">
                                <span class="po-badge">{{ item.po }}</span>
                            </ng-container>

                            <ng-container *ngSwitchDefault>
                                {{ item[col.key] }}
                            </ng-container>
                        </ng-container>
                    </td>
                </ng-container>

                <!-- Menu chọn chế độ lọc -->
                <mat-menu #filterModeMenu="matMenu">
                    <button mat-menu-item (click)="setFilterMode('constraint')">
                        <span>Constraint</span>
                    </button>
                    <button mat-menu-item (click)="setFilterMode('not_constraint')">
                        <span>Not Constraint</span>
                    </button>
                </mat-menu>

                <!-- Expanded Detail Column -->
                <ng-container matColumnDef="expandedDetail">
                    <td mat-cell *matCellDef="let item" [attr.colspan]="poParentColumnKeys.length">
                        <div class="child-detail" [@detailExpand]="item.expanded ? 'expanded' : 'collapsed'">
                            <div class="child-table-container" *ngIf="item.expanded">
                                <h4 class="child-title">Chi tiết sản phẩm trong {{ item.po }}</h4>
                                <table class="child-table">
                                    <thead>
                                        <tr>
                                            <th *ngFor="let childCol of viewColumns.poChild">{{ childCol.label }}</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr *ngFor="let child of item.children">
                                            <td *ngFor="let childCol of viewColumns.poChild">
                                                <ng-container [ngSwitch]="childCol.key">
                                                    <ng-container *ngSwitchCase="'identifier'">
                                                        <strong>{{ child[childCol.key] }}</strong>
                                                    </ng-container>
                                                    <ng-container *ngSwitchCase="'calculatedStatus'">
                                                        <span class="status-badge"
                                                            [ngClass]="getStatusClass(child.calculatedStatus)">
                                                            {{ child.calculatedStatus }}
                                                        </span>
                                                    </ng-container>
                                                    <ng-container *ngSwitchDefault>
                                                        {{ child[childCol.key] }}
                                                    </ng-container>
                                                </ng-container>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </td>
                </ng-container>

                <!-- Header & Rows -->
                <tr mat-header-row *matHeaderRowDef="poParentColumnKeys"></tr>
                <tr mat-row *matRowDef="let row; columns: poParentColumnKeys; when: isParentRow" class="parent-row"
                    [class.expanded]="row.expanded" (click)="toggleRow(row)"></tr>
                <tr mat-row *matRowDef="let row; columns: ['expandedDetail']; when: isChildRow" class="child-row"></tr>

            </table>



            <!-- Product View -->
            <table mat-table [dataSource]="productDataSource" class="warehouse-table expandable-table"
                multiTemplateDataRows *ngIf="currentViewMode === 'product'">

                <!-- Cột cha: dùng vòng lặp -->
                <ng-container *ngFor="let col of viewColumns.productParent" [matColumnDef]="col.key">
                    <th mat-header-cell *matHeaderCellDef>
                        <ng-container [ngSwitch]="col.key">
                            <!-- Cột mở rộng -->
                            <ng-container *ngSwitchCase="'expand'"></ng-container>

                            <!-- Cột identifier có search -->
                            <ng-container *ngSwitchCase="'identifier'">
                                <div class="header-content">{{ col.label }}</div>
                                <mat-form-field class="search-field" appearance="outline">
                                    <input matInput [(ngModel)]="filterValues['identifier']"
                                        (keyup.enter)="applyFilter()" [matMenuTriggerFor]="filterModeMenu" />
                                    <button mat-icon-button matSuffix [matMenuTriggerFor]="filterModeMenu">
                                        <mat-icon>keyboard_arrow_down</mat-icon>
                                    </button>
                                </mat-form-field>
                            </ng-container>

                            <!-- Các cột còn lại -->
                            <ng-container *ngSwitchDefault>
                                <div class="header-content">{{ col.label }}</div>
                                <mat-form-field class="search-field" appearance="outline">
                                    <input matInput [(ngModel)]="filterValues[col.key]" (keyup.enter)="applyFilter()" />
                                </mat-form-field>
                            </ng-container>
                        </ng-container>
                    </th>

                    <td mat-cell *matCellDef="let item">
                        <ng-container [ngSwitch]="col.key">
                            <ng-container *ngSwitchCase="'expand'">
                                <button mat-icon-button (click)="toggleRow(item); $event.stopPropagation()">
                                    <mat-icon>{{ item.expanded ? 'expand_more' : 'chevron_right' }}</mat-icon>
                                </button>
                            </ng-container>

                            <ng-container *ngSwitchDefault>
                                {{ item[col.key] }}
                            </ng-container>
                        </ng-container>
                    </td>
                </ng-container>

                <!-- Menu chọn chế độ lọc -->
                <mat-menu #filterModeMenu="matMenu">
                    <button mat-menu-item (click)="setFilterMode('constraint')">
                        <span>Constraint</span>
                    </button>
                    <button mat-menu-item (click)="setFilterMode('not_constraint')">
                        <span>Not Constraint</span>
                    </button>
                </mat-menu>

                <!-- Cột mở rộng chi tiết -->
                <ng-container matColumnDef="expandedDetail">
                    <td mat-cell *matCellDef="let item" [attr.colspan]="productParentColumnKeys.length">
                        <div class="child-detail" [@detailExpand]="item.expanded ? 'expanded' : 'collapsed'">
                            <div class="child-table-container" *ngIf="item.expanded">
                                <h4 class="child-title">Chi tiết theo từng PO/KH - {{ item.identifier }}</h4>
                                <table class="child-table">
                                    <thead>
                                        <tr>
                                            <th *ngFor="let childCol of viewColumns.productChild">{{ childCol.label }}</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr *ngFor="let child of item.children">
                                            <td *ngFor="let childCol of viewColumns.productChild">
                                                <ng-container [ngSwitch]="childCol.key">
                                                    <ng-container *ngSwitchCase="'calculatedStatus'">
                                                        <span class="status-badge"
                                                            [ngClass]="getStatusClass(child.calculatedStatus)">
                                                            {{ child.calculatedStatus }}
                                                        </span>
                                                    </ng-container>
                                                    <ng-container *ngSwitchDefault>
                                                        {{ child[childCol.key] }}
                                                    </ng-container>
                                                </ng-container>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </td>
                </ng-container>

                <!-- Header & Rows -->
                <tr mat-header-row *matHeaderRowDef="productParentColumnKeys"></tr>
                <tr mat-row *matRowDef="let row; columns: productParentColumnKeys; when: isParentRow" class="parent-row"
                    [class.expanded]="row.expanded" (click)="toggleRow(row)"></tr>
                <tr mat-row *matRowDef="let row; columns: ['expandedDetail']; when: isChildRow" class="child-row"></tr>

            </table>



            <!-- Area View -->
            <table mat-table [dataSource]="areaDataSource" class="warehouse-table expandable-table"
                multiTemplateDataRows *ngIf="currentViewMode === 'area'">

                <!-- Cột cha: dùng vòng lặp -->
                <ng-container *ngFor="let col of viewColumns.areaParent" [matColumnDef]="col.key">
                    <th mat-header-cell *matHeaderCellDef>
                        <ng-container [ngSwitch]="col.key">
                            <!-- Cột mở rộng -->
                            <ng-container *ngSwitchCase="'expand'"></ng-container>

                            <!-- Cột locationId có search -->
                            <ng-container *ngSwitchCase="'locationId'">
                                <div class="header-content">{{ col.label }}</div>
                                <mat-form-field class="search-field" appearance="outline">
                                    <input matInput [(ngModel)]="filterValues['locationId']"
                                        (keyup.enter)="applyFilter()" [matMenuTriggerFor]="filterModeMenu" />
                                    <button mat-icon-button matSuffix [matMenuTriggerFor]="filterModeMenu">
                                        <mat-icon>keyboard_arrow_down</mat-icon>
                                    </button>
                                </mat-form-field>
                            </ng-container>

                            <!-- Các cột còn lại -->
                            <ng-container *ngSwitchDefault>
                                <div class="header-content">{{ col.label }}</div>
                                <mat-form-field class="search-field" appearance="outline">
                                    <input matInput [(ngModel)]="filterValues[col.key]" (keyup.enter)="applyFilter()" />
                                </mat-form-field>
                            </ng-container>
                        </ng-container>
                    </th>

                    <td mat-cell *matCellDef="let item">
                        <ng-container [ngSwitch]="col.key">
                            <ng-container *ngSwitchCase="'expand'">
                                <button mat-icon-button (click)="toggleRow(item); $event.stopPropagation()">
                                    <mat-icon>{{ item.expanded ? 'expand_more' : 'chevron_right' }}</mat-icon>
                                </button>
                            </ng-container>

                            <ng-container *ngSwitchDefault>
                                {{ item[col.key] }}
                            </ng-container>
                        </ng-container>
                    </td>
                </ng-container>

                <!-- Menu chọn chế độ lọc -->
                <mat-menu #filterModeMenu="matMenu">
                    <button mat-menu-item (click)="setFilterMode('constraint')">
                        <span>Constraint</span>
                    </button>
                    <button mat-menu-item (click)="setFilterMode('not_constraint')">
                        <span>Not Constraint</span>
                    </button>
                </mat-menu>

                <!-- Cột mở rộng chi tiết -->
                <ng-container matColumnDef="expandedDetail">
                    <td mat-cell *matCellDef="let item" [attr.colspan]="areaParentColumnKeys.length">
                        <div class="child-detail" [@detailExpand]="item.expanded ? 'expanded' : 'collapsed'">
                            <div class="child-table-container" *ngIf="item.expanded">
                                <h4 class="child-title">Chi tiết sản phẩm trong khu vực {{ item.locationId }}</h4>
                                <table class="child-table">
                                    <thead>
                                        <tr> <!-- header dùng viewColumns.areaChild để phản ánh visibility -->
                                            <th *ngFor="let childCol of viewColumns.areaChild"
                                                [hidden]="childCol.visible === false"> {{ childCol.label }} </th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr *ngFor="let child of item.children">
                                            <!-- body dùng cùng viewColumns.areaChild -->
                                            <td *ngFor="let childCol of viewColumns.areaChild"
                                                [hidden]="childCol.visible === false">
                                                <ng-container [ngSwitch]="childCol.key">
                                                    <ng-container *ngSwitchCase="'identifier'">
                                                        <strong>{{ child[childCol.key] }}</strong>
                                                    </ng-container>
                                                    <ng-container *ngSwitchCase="'calculatedStatus'">
                                                        <span class="status-badge"
                                                            [ngClass]="getStatusClass(child.calculatedStatus)"> {{
                                                            child.calculatedStatus }}
                                                        </span>
                                                    </ng-container>
                                                    <ng-container *ngSwitchDefault>
                                                        {{ child[childCol.key] }}
                                                    </ng-container>
                                                </ng-container>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </td>
                </ng-container>

                <!-- Header & Rows -->
                <tr mat-header-row *matHeaderRowDef="areaParentColumnKeys"></tr>
                <tr mat-row *matRowDef="let row; columns: areaParentColumnKeys; when: isParentRow" class="parent-row"
                    [class.expanded]="row.expanded" (click)="toggleRow(row)"></tr>
                <tr mat-row *matRowDef="let row; columns: ['expandedDetail']; when: isChildRow" class="child-row"></tr>

            </table>



            <!-- Customer View -->
            <table mat-table [dataSource]="customerDataSource" class="warehouse-table expandable-table"
                multiTemplateDataRows *ngIf="currentViewMode === 'customer'">

                <!-- Cột cha: dùng vòng lặp -->
                <ng-container *ngFor="let col of viewColumns.customerParent" [matColumnDef]="col.key">
                    <th mat-header-cell *matHeaderCellDef>
                        <ng-container [ngSwitch]="col.key">
                            <!-- Cột mở rộng -->
                            <ng-container *ngSwitchCase="'expand'"></ng-container>

                            <!-- Cột vendor có search -->
                            <ng-container *ngSwitchCase="'vendor'">
                                <div class="header-content">{{ col.label }}</div>
                                <mat-form-field class="search-field" appearance="outline">
                                    <input matInput [(ngModel)]="filterValues['vendor']" (keyup.enter)="applyFilter()"
                                        [matMenuTriggerFor]="filterModeMenu" />
                                    <button mat-icon-button matSuffix [matMenuTriggerFor]="filterModeMenu">
                                        <mat-icon>keyboard_arrow_down</mat-icon>
                                    </button>
                                </mat-form-field>
                            </ng-container>

                            <!-- Các cột còn lại -->
                            <ng-container *ngSwitchDefault>
                                <div class="header-content">{{ col.label }}</div>
                                <mat-form-field class="search-field" appearance="outline">
                                    <input matInput [(ngModel)]="filterValues[col.key]" (keyup.enter)="applyFilter()" />
                                </mat-form-field>
                            </ng-container>
                        </ng-container>
                    </th>

                    <td mat-cell *matCellDef="let item">
                        <ng-container [ngSwitch]="col.key">
                            <ng-container *ngSwitchCase="'expand'">
                                <button mat-icon-button (click)="toggleRow(item); $event.stopPropagation()">
                                    <mat-icon>{{ item.expanded ? 'expand_more' : 'chevron_right' }}</mat-icon>
                                </button>
                            </ng-container>

                            <ng-container *ngSwitchDefault>
                                {{ item[col.key] }}
                            </ng-container>
                        </ng-container>
                    </td>
                </ng-container>

                <!-- Menu chọn chế độ lọc -->
                <mat-menu #filterModeMenu="matMenu">
                    <button mat-menu-item (click)="setFilterMode('constraint')">
                        <span>Constraint</span>
                    </button>
                    <button mat-menu-item (click)="setFilterMode('not_constraint')">
                        <span>Not Constraint</span>
                    </button>
                </mat-menu>

                <!-- Cột mở rộng chi tiết -->
                <ng-container matColumnDef="expandedDetail">
                    <td mat-cell *matCellDef="let item" [attr.colspan]="customerParentColumnKeys.length">
                        <div class="child-detail" [@detailExpand]="item.expanded ? 'expanded' : 'collapsed'">
                            <div class="child-table-container" *ngIf="item.expanded">
                                <h4 class="child-title">Chi tiết sản phẩm của khách hàng {{ item.vendor }}</h4>
                                <table class="child-table">
                                    <thead>
                                        <tr>
                                            <th *ngFor="let childCol of viewColumns.customerChild">{{ childCol.label }}</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr *ngFor="let child of item.children">
                                            <td *ngFor="let childCol of viewColumns.customerChild">
                                                <ng-container [ngSwitch]="childCol.key">
                                                    <ng-container *ngSwitchCase="'identifier'">
                                                        <strong>{{ child[childCol.key] }}</strong>
                                                    </ng-container>
                                                    <ng-container *ngSwitchCase="'calculatedStatus'">
                                                        <span class="status-badge"
                                                            [ngClass]="getStatusClass(child.calculatedStatus)">
                                                            {{ child.calculatedStatus }}
                                                        </span>
                                                    </ng-container>
                                                    <ng-container *ngSwitchDefault>
                                                        {{ child[childCol.key] }}
                                                    </ng-container>
                                                </ng-container>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </td>
                </ng-container>

                <!-- Header & Rows -->
                <tr mat-header-row *matHeaderRowDef="customerParentColumnKeys"></tr>
                <tr mat-row *matRowDef="let row; columns: customerParentColumnKeys; when: isParentRow"
                    class="parent-row" [class.expanded]="row.expanded" (click)="toggleRow(row)"></tr>
                <tr mat-row *matRowDef="let row; columns: ['expandedDetail']; when: isChildRow" class="child-row"></tr>

            </table>

            <div class="mobile-expandable-list" *ngIf="currentViewMode === 'customer'">
                <!-- Mobile Filter Toggle -->
                <div class="mobile-filter-section">
                    <button mat-stroked-button (click)="toggleMobileFilter()" class="filter-toggle-btn">
                        <span style="display: flex; align-items: center; gap: 8px;">
                            <mat-icon>filter_list</mat-icon>
                            Bộ lọc
                        </span>
                        <mat-icon>{{showMobileFilter ? 'expand_less' : 'expand_more'}}</mat-icon>
                    </button>

                    <!-- Filters Panel -->
                    <div class="mobile-filters" [class.show]="showMobileFilter">
                        <!-- Vendor filter -->
                        <mat-form-field appearance="outline" class="filter-field">
                            <mat-label>Khách hàng</mat-label>
                            <input matInput [(ngModel)]="filterValues['vendor']" (keyup.enter)="applyFilter()">
                            <button mat-icon-button matSuffix>
                                <mat-icon>keyboard_arrow_down</mat-icon>
                            </button>
                        </mat-form-field>

                        <!-- Other filters -->
                        <mat-form-field appearance="outline" class="filter-field" *ngFor="let col of getFilterColumn()">
                            <mat-label>{{ col.label }}</mat-label>
                            <input matInput [(ngModel)]="filterValues[col.key]" (keyup.enter)="applyFilter()">
                        </mat-form-field>


                        <div class="filter-actions">
                            <button mat-button (click)="clearFilters()">
                                <mat-icon>clear</mat-icon>
                                Xóa
                            </button>
                            <button mat-raised-button color="primary" (click)="applyFilter(); toggleMobileFilter()">
                                <mat-icon>check</mat-icon>
                                Áp dụng
                            </button>
                        </div>
                    </div>
                </div>

                <div class="expandable-cards">
                    <div class="expandable-card" *ngFor="let item of customerDataSource"
                        [class.expanded]="item.expanded">

                        <!-- Cha Card -->
                        <div class="parent-card" (click)="toggleRow(item)">
                            <!-- Card Header -->
                            <div class="card-header">
                                <div class="header-left">
                                    <div class="customer-name">{{item.vendor}}</div>
                                </div>
                                <div class="header-right">
                                    <button mat-icon-button class="expand-btn"
                                        (click)="$event.stopPropagation(); toggleRow(item)">
                                        <mat-icon>{{item.expanded ? 'expand_less' : 'expand_more'}}</mat-icon>
                                    </button>
                                </div>
                            </div>

                            <!-- Stats Grid -->
                            <div class="stats-grid">
                                <div class="stat-item">
                                    <div class="stat-icon inventory">
                                        <mat-icon>inventory</mat-icon>
                                    </div>
                                    <div class="stat-info">
                                        <div class="stat-label">SL Tồn</div>
                                        <div class="stat-value">{{item.totalAvailableQuantity}}</div>
                                    </div>
                                </div>

                                <div class="stat-item">
                                    <div class="stat-icon product">
                                        <mat-icon>category</mat-icon>
                                    </div>
                                    <div class="stat-info">
                                        <div class="stat-label">Số lượng SP</div>
                                        <div class="stat-value">{{item.itemCount}}</div>
                                    </div>
                                </div>

                                <div class="stat-item">
                                    <div class="stat-icon client">
                                        <mat-icon>groups</mat-icon>
                                    </div>
                                    <div class="stat-info">
                                        <div class="stat-label">Khách hàng</div>
                                        <div class="stat-value">{{item.totalClients}}</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Expand Indicator -->
                            <div class="expand-indicator" *ngIf="(item.children?.length || 0) > 0">
                                <span>{{ item.children?.length || 0 }} sản phẩm</span>
                                <mat-icon>{{item.expanded ? 'keyboard_arrow_up' : 'keyboard_arrow_down'}}</mat-icon>
                            </div>
                        </div>

                        <!-- Children Cards (Expanded Content) -->
                        <div class="children-container" [@detailExpand]="item.expanded ? 'expanded' : 'collapsed'">
                            <div class="children-header">
                                <mat-icon>inventory</mat-icon>
                                <span>Chi tiết sản phẩm của {{item.vendor}}</span>
                            </div>

                            <div class="child-cards">
                                <div class="child-card" *ngFor="let child of item.children; let i = index">
                                    <div class="child-number">#{{i + 1}}</div>

                                    <div class="child-main">
                                        <div class="product-code">{{child.identifier}}</div>
                                        <div class="product-name">{{child.name}}</div>
                                    </div>

                                    <div class="child-details">
                                        <div class="detail-row">
                                            <span class="label">PO:</span>
                                            <span class="value po-badge">{{child.po}}</span>
                                        </div>
                                        <div class="detail-row">
                                            <span class="label">SL Tồn:</span>
                                            <span class="value quantity">{{child.availableQuantity}}</span>
                                        </div>
                                        <div class="detail-row">
                                            <span class="label">SL Gốc:</span>
                                            <span class="value">{{child.initialQuantity}}</span>
                                        </div>
                                        <div class="detail-row">
                                            <span class="label">Location:</span>
                                            <span class="value location-badge">{{child.locationCode}}</span>
                                        </div>
                                        <div class="detail-row">
                                            <span class="label">Pallet:</span>
                                            <span class="value">{{child.serialPallet}}</span>
                                        </div>
                                        <div class="detail-row">
                                            <span class="label">Status:</span>
                                            <span class="value">
                                                <span class="status-badge"
                                                    [ngClass]="getStatusClass(child.calculatedStatus)">
                                                    {{child.calculatedStatus}}
                                                </span>
                                            </span>
                                        </div>
                                        <div class="detail-row">
                                            <span class="label">Ngày nhập:</span>
                                            <span class="value">{{child.receivedDate}}</span>
                                        </div>
                                        <div class="detail-row">
                                            <span class="label">Ngày cập nhật:</span>
                                            <span class="value">{{child.updatedDate}}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="mobile-warehouse-list" *ngIf="currentViewMode === 'default'">
                <div class="mobile-warehouse-card" *ngFor="let item of warehouseList; let i = index">
                    <div class="card-header">
                        <div class="card-id">
                            <span class="stt">#{{ i + 1 }}</span>
                            <span class="product-code">{{ item.identifier }}</span>
                        </div>
                        <span class="status-badge" [ngClass]="getStatusClass(item.calculatedStatus)">
                            {{ item.calculatedStatus }}
                        </span>
                    </div>

                    <div class="card-content">
                        <div class="info-row" *ngFor="let field of mobileDefaultFields">
                            <span class="label">{{ field.label }}</span>
                            <span class="value" [ngClass]="field.badge ? 'location-badge' : ''">
                                {{ $any(item)[field.key] }}
                            </span>
                        </div>

                        <div class="quantity-row">
                            <div class="qty-box" *ngFor="let field of mobileQuantityFields" [ngClass]="field.class">
                                <div class="qty-label">{{ field.label }}</div>
                                <div class="qty-value">{{ $any(item)[field.key] }}</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="mobile-warehouse-list view-po" *ngIf="currentViewMode === 'po'">
            <div class="mobile-expandable-card" *ngFor="let item of poDataSource">
                <div class="parent-header" (click)="toggleRow(item)">
                    <div class="parent-info">
                        <div class="parent-title">{{ item.po }}</div>
                    </div>
                    <div class="expand-icon" [class.expanded]="item.expanded">
                        <span class="badge">{{ item.children?.length || 0 }}</span>
                        <mat-icon>chevron_right</mat-icon>
                    </div>
                </div>

                <div class="parent-stats">
                    <div class="stat-item" *ngFor="let stat of mobilePOStats">
                        <div class="stat-label">{{ stat.label }}</div>
                        <div class="stat-value">{{ $any(item)[stat.key] }}</div>
                    </div>
                </div>

                <div class="children-list" [class.show]="item.expanded">
                    <div class="child-item" *ngFor="let child of item.children">
                        <div class="child-row" *ngFor="let field of mobilePOChildFields">
                            <span class="label">{{ field.label }}</span>
                            <span class="value">
                                <ng-container [ngSwitch]="field.badge">
                                    <ng-container *ngSwitchCase="true">
                                        <span class="status-badge" [ngClass]="getStatusClass(child.calculatedStatus)">
                                            {{ child.calculatedStatus }}
                                        </span>
                                    </ng-container>
                                    <ng-container *ngSwitchDefault>
                                        <strong *ngIf="field.bold">{{ $any(child)[field.key] }}</strong>
                                        <span *ngIf="!field.bold">{{ $any(child)[field.key] }}</span>
                                    </ng-container>
                                </ng-container>
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>




        <!-- Pagination -->
        <div class="pagination">
            <!-- Page size select -->
            <mat-form-field class="page-size-select" appearance="outline">
                <mat-select [(value)]="pageSize" (selectionChange)="onPageSizeChange($event.value)">
                    <mat-option [value]="10">10</mat-option>
                    <mat-option [value]="25">25</mat-option>
                    <mat-option [value]="50">50</mat-option>
                    <mat-option [value]="100">100</mat-option>
                </mat-select>
            </mat-form-field>

            <!-- Page buttons -->
            <div class="pagination-buttons">
                <button mat-icon-button (click)="onPageChange(currentPage - 1)" [disabled]="currentPage === 1">
                    <mat-icon>chevron_left</mat-icon>
                </button>

                <span class="page-info">
                    Trang {{ currentPage }} / {{ totalPages }}
                </span>

                <button mat-icon-button (click)="onPageChange(currentPage + 1)" [disabled]="currentPage === totalPages">
                    <mat-icon>chevron_right</mat-icon>
                </button>
            </div>
        </div>

    </mat-card>
</div>