<div class="dialog-container">
    <div class="dialog-header">
        <div class="header-title">
            <mat-icon>qr_code_scanner</mat-icon>
            <div>
                <h2>Scan check</h2>
                <p class="subtitle">Internal warehouse transfer</p>
            </div>
        </div>
        <button mat-icon-button mat-dialog-close>
            <mat-icon>close</mat-icon>
        </button>
    </div>

    <mat-dialog-content>
        <mat-progress-bar *ngIf="isLoading" mode="indeterminate"></mat-progress-bar>
        
        <!-- Scan Mode Selection -->
        <div class="mode-section">
            <div class="section-title">
                <mat-icon>qr_code_2</mat-icon>
                <span>Chọn vật cần scan</span>
            </div>

            <div class="mode-buttons">
                <button *ngIf="mode !== 'update'" mat-raised-button class="mode-btn"
                    [class.active]="selectedScanMode === 'pallet'" (click)="toggleScanMode('pallet')">
                    <mat-icon>inventory_2</mat-icon>
                    Pallet
                </button>

                <button mat-raised-button class="mode-btn" [class.active]="selectedScanMode === 'box'"
                    (click)="toggleScanMode('box')">
                    <mat-icon>widgets</mat-icon>
                    Thùng
                </button>
            </div>
        </div>

        <!-- ✅ SCAN INPUTS - LUÔN HIỂN THỊ SAU KHI CHỌN MODE -->
        <div class="scan-inputs" *ngIf="selectedScanMode">
            <div class="input-with-camera">
                <mat-form-field class="scan-field" appearance="outline">
                    <mat-label>{{ selectedScanMode === 'pallet' ? 'Pallet scan...' : 'Box scan...' }}</mat-label>
                    <input matInput [(ngModel)]="palletScan" #palletInput
                        (keydown.enter)="mode === 'transfer' ? focusLocationInput() : onScanComplete()"
                        inputmode="none" />
                </mat-form-field>

                <button mat-icon-button class="camera-btn" (click)="openCameraScanner('pallet')"
                    matTooltip="Quét bằng camera">
                    <mat-icon>photo_camera</mat-icon>
                </button>
            </div>

            <div class="input-with-camera" *ngIf="mode === 'transfer'">
                <mat-form-field class="scan-field" appearance="outline">
                    <mat-label>Tên kho chuyển đến...</mat-label>
                    <input matInput [(ngModel)]="locationScan" #locationInput (keydown.enter)="onScanComplete()"
                        inputmode="none" />
                </mat-form-field>

                <button mat-icon-button class="camera-btn" (click)="openCameraScanner('location')"
                    matTooltip="Quét location">
                    <mat-icon>photo_camera</mat-icon>
                </button>
            </div>
        </div>

        <!-- Update Quantity Section -->
        <div class="update-quantity" *ngIf="mode === 'update' && isInfoVisible">
            <h3>Cập nhật số lượng tồn:</h3>
            <mat-form-field class="quantity-field" appearance="outline">
                <mat-label>Số lượng tồn...</mat-label>
                <input matInput type="number" [(ngModel)]="updatedQuantity" />
            </mat-form-field>
        </div>

        <!-- ✅ INFORMATION SECTION - TỐI ƯU CHO MOBILE -->
        <div class="info-section" *ngIf="isInfoVisible && mode !== 'transfer'">
            <div class="section-title">
                <mat-icon>info</mat-icon>
                <span>Thông tin sản phẩm</span>
            </div>

            <!-- Desktop View -->
            <div class="info-grid desktop-only">
                <div class="info-row">
                    <div class="info-item">
                        <span class="info-label">Mã sản phẩm:</span>
                        <span class="info-value">{{ productInfo.maSanPham }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Mã thùng:</span>
                        <span class="info-value">{{ productInfo.maThung }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Cập nhật bởi:</span>
                        <span class="info-value">{{ productInfo.capNhatBoi }}</span>
                    </div>
                </div>

                <div class="info-row">
                    <div class="info-item">
                        <span class="info-label">Tên sản phẩm:</span>
                        <span class="info-value">{{ productInfo.tenSanPham }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Location:</span>
                        <span class="info-value">{{ productInfo.location }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Scan bởi:</span>
                        <span class="info-value">{{ productInfo.scanBoi }}</span>
                    </div>
                </div>

                <div class="info-row">
                    <div class="info-item">
                        <span class="info-label">Tên khách hàng:</span>
                        <span class="info-value">{{ productInfo.tenKhachHang }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Area:</span>
                        <span class="info-value">{{ productInfo.area }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Số lượng gốc:</span>
                        <span class="info-value">{{ productInfo.soLuongGoc }}</span>
                    </div>
                </div>

                <div class="info-row">
                    <div class="info-item">
                        <span class="info-label">Khách hàng:</span>
                        <span class="info-value">{{ productInfo.maKhachHang }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Trạng thái:</span>
                        <span class="info-value status-badge">{{ productInfo.trangThai }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Số lượng hiện tại:</span>
                        <span class="info-value">{{ productInfo.soLuongHienTai }}</span>
                    </div>
                </div>

                <div class="info-row">
                    <div class="info-item">
                        <span class="info-label">Mã Pallet:</span>
                        <span class="info-value">{{ productInfo.maPallet }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Ngày cập nhật:</span>
                        <span class="info-value">{{ productInfo.ngayCapNhat }}</span>
                    </div>
                    <div class="info-item"></div>
                </div>

                <div class="info-row">
                    <div class="info-item">
                        <span class="info-label">PO:</span>
                        <span class="info-value">{{ productInfo.po }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">LOT:</span>
                        <span class="info-value">{{ productInfo.lot }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Part Number:</span>
                        <span class="info-value">{{ productInfo.partNumber }}</span>
                    </div>
                </div>

                <div class="info-row">
                    <div class="info-item">
                        <span class="info-label">Ngày sản xuất:</span>
                        <span class="info-value">{{ productInfo.ngaySanXuat }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Hạn sử dụng:</span>
                        <span class="info-value">{{ productInfo.hanSuDung }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Ghi chú:</span>
                        <span class="info-value">{{ productInfo.ghiChu }}</span>
                    </div>
                </div>
            </div>

            <!-- ✅ MOBILE VIEW - COMPACT CARD LAYOUT -->
            <div class="info-mobile mobile-only">
                <div class="info-card">
                    <div class="info-item-mobile">
                        <span class="label">Mã SP</span>
                        <span class="value">{{ productInfo.maSanPham }}</span>
                    </div>
                    <div class="info-item-mobile">
                        <span class="label">Mã thùng</span>
                        <span class="value">{{ productInfo.maThung }}</span>
                    </div>
                </div>

                <div class="info-card">
                    <div class="info-item-mobile">
                        <span class="label">Tên sản phẩm</span>
                        <span class="value">{{ productInfo.tenSanPham }}</span>
                    </div>
                </div>

                <div class="info-card">
                    <div class="info-item-mobile">
                        <span class="label">Location</span>
                        <span class="value">{{ productInfo.location }}</span>
                    </div>
                    <div class="info-item-mobile">
                        <span class="label">Area</span>
                        <span class="value">{{ productInfo.area }}</span>
                    </div>
                </div>

                <div class="info-card">
                    <div class="info-item-mobile">
                        <span class="label">Trạng thái</span>
                        <span class="value status-badge">{{ productInfo.trangThai }}</span>
                    </div>
                    <div class="info-item-mobile">
                        <span class="label">SL hiện tại</span>
                        <span class="value highlight">{{ productInfo.soLuongHienTai }}</span>
                    </div>
                </div>

                <div class="info-card">
                    <div class="info-item-mobile">
                        <span class="label">PO</span>
                        <span class="value">{{ productInfo.po }}</span>
                    </div>
                    <div class="info-item-mobile">
                        <span class="label">LOT</span>
                        <span class="value">{{ productInfo.lot }}</span>
                    </div>
                </div>

                <div class="info-card">
                    <div class="info-item-mobile">
                        <span class="label">Scan bởi</span>
                        <span class="value">{{ productInfo.scanBoi }}</span>
                    </div>
                    <div class="info-item-mobile">
                        <span class="label">Cập nhật</span>
                        <span class="value">{{ productInfo.ngayCapNhat }}</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- ✅ TRANSFER TABLE - DESKTOP VIEW -->
        <div class="transfer-table desktop-only" *ngIf="mode === 'transfer' && scannedItems.length > 0">
            <div class="section-title">
                <mat-icon>list</mat-icon>
                <span>Danh sách đã scan ({{ scannedItems.length }})</span>
            </div>

            <table class="scan-table">
                <thead>
                    <tr>
                        <th>{{ selectedScanMode === 'box' ? 'Mã thùng' : 'Mã pallet' }}</th>
                        <th>Location mới</th>
                        <th>Ngày scan</th>
                        <th>Scan bởi</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <tr *ngFor="let item of scannedItems; let i = index">
                        <td>{{ item.code }}</td>
                        <td>{{ item.location }}</td>
                        <td>{{ item.scannedAt }}</td>
                        <td>{{ item.scannedBy }}</td>
                        <td>
                            <button mat-icon-button color="warn" (click)="removeScannedItem(i)">
                                <mat-icon>delete</mat-icon>
                            </button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- ✅ TRANSFER CARDS - MOBILE VIEW -->
        <div class="transfer-cards mobile-only" *ngIf="mode === 'transfer' && scannedItems.length > 0">
            <div class="section-title">
                <mat-icon>list</mat-icon>
                <span>Đã scan ({{ scannedItems.length }})</span>
            </div>

            <div class="scanned-items-list">
                <div class="scanned-item-card" *ngFor="let item of scannedItems; let i = index">
                    <div class="card-header">
                        <mat-icon class="card-icon">{{ selectedScanMode === 'box' ? 'widgets' : 'inventory_2' }}</mat-icon>
                        <span class="item-code">{{ item.code }}</span>
                        <button mat-icon-button color="warn" class="delete-btn" (click)="removeScannedItem(i)">
                            <mat-icon>delete_outline</mat-icon>
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="card-info-row">
                            <mat-icon class="small-icon">place</mat-icon>
                            <span class="card-label">Location:</span>
                            <span class="card-value">{{ item.location }}</span>
                        </div>
                        <div class="card-info-row">
                            <mat-icon class="small-icon">schedule</mat-icon>
                            <span class="card-label">Thời gian:</span>
                            <span class="card-value">{{ item.scannedAt }}</span>
                        </div>
                        <div class="card-info-row">
                            <mat-icon class="small-icon">person</mat-icon>
                            <span class="card-label">Scan bởi:</span>
                            <span class="card-value">{{ item.scannedBy }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </mat-dialog-content>

    <!-- ✅ ACTIONS - LUÔN HIỂN THỊ KHI CÓ DATA -->
    <mat-dialog-actions align="end" *ngIf="isInfoVisible && (mode === 'update' || (mode === 'transfer' && scannedItems.length > 0))">
        <button mat-button (click)="onCancel()">Huỷ</button>
        <button mat-raised-button color="primary" class="save-btn" (click)="onSave()">
            <mat-icon>save</mat-icon>
            Lưu
        </button>
    </mat-dialog-actions>

</div>

<!-- Camera Scanner Overlay -->
<div class="qr-scanner-overlay" *ngIf="isScanning" (click)="stopScanning()">
    <div class="qr-scanner-modal" (click)="$event.stopPropagation()">
        <div class="scanner-header">
            <h3>Quét mã</h3>
            <div class="scanner-actions">
                <button mat-icon-button *ngIf="availableCameras.length > 1" (click)="switchCamera()"
                    matTooltip="Chuyển camera" class="switch-camera-btn">
                    <mat-icon>flip_camera_android</mat-icon>
                </button>
                <button mat-icon-button (click)="stopScanning()">
                    <mat-icon>close</mat-icon>
                </button>
            </div>
        </div>
        <div id="qr-reader" style="width: 100%; max-width: 500px; margin: 0 auto;"></div>
        <p class="scanner-hint">Đưa mã vào khung hình để quét</p>
    </div>
</div>