<div class="xuat-hang-ban-container">
    <div class="xuat-hang-ban-header">
        <div class="header-title">
            <mat-icon class="title-icon">store</mat-icon>
            <div>
                <h1>Yêu cầu xuất hàng theo đơn hàng bán</h1>
                <p class="subtitle">Ship goods according to sales orders</p>
            </div>
        </div>
        <button mat-raised-button color="primary" class="add-btn" (click)="onAddNew()">
            <mat-icon>add_circle</mat-icon>
            Thêm mới yêu cầu
        </button>
    </div>

    <!-- Content Card -->
    <mat-card class="nhapkho-card">
        <!-- Table Header -->
        <div class="table-header">
            <div class="table-title">
                <mat-icon>list</mat-icon>
                <span>Danh sách xuất hàng bán ({{totalItems}})</span>
            </div>
            <div class="table-actions">
                <button mat-raised-button (click)="onRefresh()" class="refresh-btn icon-only">
                    <mat-icon color="primary">sync</mat-icon>
                </button>
            </div>
        </div>

        <!-- Table -->
        <div class="table-container">
            <table mat-table [dataSource]="pagedSalesRequests" class="chuyenkho-table">
                <!-- ID Column -->
                <ng-container matColumnDef="id">
                    <th mat-header-cell *matHeaderCellDef style="width: 50px !important; min-width: 50px;">ID</th>
                    <td mat-cell *matCellDef="let chuyenkho">{{chuyenkho.id}}</td>
                </ng-container>

                <!-- Code Column -->
                <ng-container matColumnDef="ma_yc_xk">
                    <th mat-header-cell *matHeaderCellDef>
                        <div class="header-cell">
                            <div>Mã Location</div>
                            <mat-form-field class="search-field" appearance="outline">
                                <input matInput [(ngModel)]="filterValues.ma_yc_xk" [(ngModel)]="searchTerm"
                                    (keyup.enter)="applyFilter()">
                            </mat-form-field>

                        </div>
                    </th>
                    <td mat-cell *matCellDef="let chuyenkho">{{chuyenkho.ma_yc_xk}}</td>
                </ng-container>

                <ng-container matColumnDef="kho_xuat">
                    <th mat-header-cell *matHeaderCellDef>
                        <div>Từ kho</div>
                        <mat-form-field class="search-field" appearance="outline">
                            <input matInput [(ngModel)]="filterValues.kho_xuat" [(ngModel)]="searchTerm"
                                (keyup.enter)="applyFilter()">
                        </mat-form-field>
                    </th>
                    <td mat-cell *matCellDef="let chuyenkho">{{chuyenkho.ten_kho_xuat }}</td>
                </ng-container>
                <ng-container matColumnDef="xuat_toi">
                    <th mat-header-cell *matHeaderCellDef>
                        <div>Đến kho</div>
                        <mat-form-field class="search-field" appearance="outline">
                            <input matInput [(ngModel)]="filterValues.xuat_toi" [(ngModel)]="searchTerm"
                                (keyup.enter)="applyFilter()">
                        </mat-form-field>
                    </th>
                    <td mat-cell *matCellDef="let chuyenkho">{{chuyenkho.ten_kho_nhan}}</td>
                </ng-container>
                <ng-container matColumnDef="don_vi_linh">
                    <th mat-header-cell *matHeaderCellDef>
                        <div>Đơn vị lĩnh</div>
                        <mat-form-field class="search-field" appearance="outline">
                            <input matInput [(ngModel)]="filterValues.don_vi_linh" [(ngModel)]="searchTerm"
                                (keyup.enter)="applyFilter()">
                        </mat-form-field>
                    </th>
                    <td mat-cell *matCellDef="let chuyenkho">{{chuyenkho.don_vi_linh}}</td>
                </ng-container>
                <ng-container matColumnDef="don_vi_nhan">
                    <th mat-header-cell *matHeaderCellDef>
                        <div>Đơn vị nhận</div>
                        <mat-form-field class="search-field" appearance="outline">
                            <input matInput [(ngModel)]="filterValues.don_vi_nhan" [(ngModel)]="searchTerm"
                                (keyup.enter)="applyFilter()">
                        </mat-form-field>
                    </th>
                    <td mat-cell *matCellDef="let chuyenkho">{{chuyenkho.don_vi_nhan}}</td>
                </ng-container>
                <ng-container matColumnDef="ly_do_xuat_nhap">
                    <th mat-header-cell *matHeaderCellDef>
                        <div>Lý do xuất/nhập</div>
                        <mat-form-field class="search-field" appearance="outline">
                            <input matInput [(ngModel)]="filterValues.ly_do_xuat_nhap" [(ngModel)]="searchTerm"
                                (keyup.enter)="applyFilter()">
                        </mat-form-field>
                    </th>
                    <td mat-cell *matCellDef="let chuyenkho">{{chuyenkho.ly_do_xuat_nhap}}</td>
                </ng-container>

                <!-- Type Column -->
                <!-- <ng-container matColumnDef="type">
                    <th mat-header-cell *matHeaderCellDef>
                        <div>Type</div>
                        <mat-form-field class="search-field" appearance="outline">
                            <input matInput [(ngModel)]="searchTerm" (keyup.enter)="applyFilter()">
                        </mat-form-field>
                    </th>
                    <td mat-cell *matCellDef="let chuyenkho">
                        <span class="type-badge type-move">
                            {{getTypeLabel(chuyenkho.type)}}
                        </span>
                    </td>
                </ng-container> -->

                <ng-container matColumnDef="ngay_chung_tu">
                    <th mat-header-cell *matHeaderCellDef>
                        <div>Ngày chứng từ</div>
                        <mat-form-field class="search-field" appearance="outline" style="width: 5rem;">
                            <input matInput [(ngModel)]="filterValues.ngay_chung_tu" [(ngModel)]="searchTerm"
                                (keyup.enter)="applyFilter()">
                        </mat-form-field>
                    </th>
                    <td mat-cell *matCellDef="let chuyenkho">{{chuyenkho.ngay_chung_tu}}</td>
                </ng-container>

                <ng-container matColumnDef="so_phieu_xuat">
                    <th mat-header-cell *matHeaderCellDef>
                        <div>Số phiếu xuất</div>
                        <mat-form-field class="search-field" appearance="outline" style="width: 5rem;">
                            <input matInput [(ngModel)]="filterValues.so_phieu_xuat" [(ngModel)]="searchTerm"
                                (keyup.enter)="applyFilter()">
                        </mat-form-field>
                    </th>
                    <td mat-cell *matCellDef="let chuyenkho">{{chuyenkho.so_phieu_xuat}}</td>
                </ng-container>

                <ng-container matColumnDef="so_chung_tu">
                    <th mat-header-cell *matHeaderCellDef>
                        <div>Số chứng từ</div>
                        <mat-form-field class="search-field" appearance="outline" style="width: 5rem;">
                            <input matInput [(ngModel)]="filterValues.so_chung_tu" [(ngModel)]="searchTerm"
                                (keyup.enter)="applyFilter()">
                        </mat-form-field>
                    </th>
                    <td mat-cell *matCellDef="let chuyenkho">{{chuyenkho.so_chung_tu}}</td>
                </ng-container>
                <ng-container matColumnDef="series_PGH">
                    <th mat-header-cell *matHeaderCellDef>
                        <div>Serial PGH</div>
                        <mat-form-field class="search-field" appearance="outline" style="width: 4rem;">
                            <input matInput [(ngModel)]="filterValues.series_PGH" [(ngModel)]="searchTerm"
                                (keyup.enter)="applyFilter()">
                        </mat-form-field>
                    </th>
                    <td mat-cell *matCellDef="let chuyenkho">{{chuyenkho.series_PGH}}</td>
                </ng-container>

                <ng-container matColumnDef="status">
                    <th mat-header-cell *matHeaderCellDef>
                        <div>Status</div>
                        <mat-form-field class="search-field" appearance="outline">
                            <mat-select [(ngModel)]="filterValues.status" (selectionChange)="applyFilter()"
                                placeholder="Chọn loại">
                                <mat-option value="">Tất cả</mat-option>
                                <mat-option value="Đã duyệt">Đã duyệt</mat-option>
                                <mat-option value="Chưa duyệt">Chưa duyệt</mat-option>
                            </mat-select>
                        </mat-form-field>
                    </th>
                    <td mat-cell *matCellDef="let chuyenkho">
                        <span class="status-badge" [ngClass]="getStatusClass(chuyenkho.status)">
                            {{ chuyenkho.status ? 'Đã duyệt' : 'Chưa duyệt' }}
                        </span>
                    </td>
                </ng-container>

                <ng-container matColumnDef="scan_status">
                    <th mat-header-cell *matHeaderCellDef>
                        <div>Scan Status</div>
                        <mat-form-field class="search-field" appearance="outline">
                            <mat-select [(ngModel)]="filterValues.scan_status" (selectionChange)="applyFilter()"
                                placeholder="Chọn loại">
                                <mat-option value="">Tất cả</mat-option>
                                <mat-option value="Đã scan">Đã scan</mat-option>
                                <mat-option value="Chưa scan">Chưa scan</mat-option>
                            </mat-select>
                        </mat-form-field>
                    </th>
                    <td mat-cell *matCellDef="let chuyenkho">
                        <span class="status-badge" [ngClass]="getScanClass(chuyenkho.scan_status)">
                            {{ chuyenkho.scan_status ? 'Đã scan' : 'Chưa scan' }}
                        </span>
                    </td>
                </ng-container>

                <!-- Actions Column -->
                <ng-container matColumnDef="actions">
                    <th mat-header-cell *matHeaderCellDef class="text-center">Options</th>
                    <td mat-cell *matCellDef="let chuyenkho" class="text-center">
                        <button mat-mini-fab class="action-btn detail-btn" (click)="onDetail(chuyenkho)">
                            <mat-icon>playlist_add_check</mat-icon>
                        </button>
                    </td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                <tr mat-row *matRowDef="let row; columns: displayedColumns;" class="table-row"></tr>
            </table>
        </div>
        <!-- Mobile Filter Toggle -->
        <div class="mobile-filter-toggle">
            <button mat-stroked-button (click)="toggleMobileFilters()" class="filter-toggle-btn">
                <span style="display: flex; align-items: center; gap: 8px;">
                    <mat-icon>filter_list</mat-icon>
                    Bộ lọc
                </span>
                <mat-icon>{{showMobileFilters ? 'expand_less' : 'expand_more'}}</mat-icon>
            </button>
        </div>

        <!-- Mobile Filters Panel -->
        <div class="mobile-filters" [class.show]="showMobileFilters">
            <mat-form-field class="filter-field" appearance="outline">
                <mat-label>Mã yêu cầu</mat-label>
                <input matInput [(ngModel)]="filterValues.ma_yc_xk" (keyup.enter)="applyFilter()">
                <mat-icon matSuffix>search</mat-icon>
            </mat-form-field>

            <mat-form-field class="filter-field" appearance="outline">
                <mat-label>Từ kho</mat-label>
                <input matInput [(ngModel)]="filterValues.kho_xuat" (keyup.enter)="applyFilter()">
                <mat-icon matSuffix>search</mat-icon>
            </mat-form-field>

            <mat-form-field class="filter-field" appearance="outline">
                <mat-label>Đến kho</mat-label>
                <input matInput [(ngModel)]="filterValues.xuat_toi" (keyup.enter)="applyFilter()">
                <mat-icon matSuffix>search</mat-icon>
            </mat-form-field>

            <mat-form-field class="filter-field" appearance="outline">
                <mat-label>Đơn vị lĩnh</mat-label>
                <input matInput [(ngModel)]="filterValues.don_vi_linh" (keyup.enter)="applyFilter()">
                <mat-icon matSuffix>search</mat-icon>
            </mat-form-field>
             <mat-form-field class="filter-field" appearance="outline">
                <mat-label>Đơn vị nhận</mat-label>
                <input matInput [(ngModel)]="filterValues.don_vi_nhan" (keyup.enter)="applyFilter()">
                <mat-icon matSuffix>search</mat-icon>
            </mat-form-field>

            <mat-form-field class="filter-field" appearance="outline">
                <mat-label>Status</mat-label>
                <mat-select [(ngModel)]="filterValues.status" (selectionChange)="applyFilter()">
                    <mat-option value="">Tất cả</mat-option>
                    <mat-option value="Đã duyệt">Đã duyệt</mat-option>
                    <mat-option value="Chưa duyệt">Chưa duyệt</mat-option>
                </mat-select>
            </mat-form-field>

            <mat-form-field class="filter-field" appearance="outline">
                <mat-label>Scan Status</mat-label>
                <mat-select [(ngModel)]="filterValues.scan_status" (selectionChange)="applyFilter()">
                    <mat-option value="">Tất cả</mat-option>
                    <mat-option value="Đã scan">Đã scan</mat-option>
                    <mat-option value="Chưa scan">Chưa scan</mat-option>
                </mat-select>
            </mat-form-field>

            <div class="filter-actions">
                <button mat-button (click)="clearFilters()">
                    <mat-icon>clear</mat-icon>
                    Xóa
                </button>
                <button mat-raised-button color="primary" (click)="applyFilter(); toggleMobileFilters()">
                    <mat-icon>check</mat-icon>
                    Áp dụng
                </button>
            </div>
        </div>

        <!-- Mobile Card List -->
        <div class="mobile-chuyenkho-list">
            <div class="mobile-chuyenkho-card" *ngFor="let item of filteredData">
                <!-- Card Header -->
                <div class="card-header">
                    <div class="card-main-info">
                        <div class="card-id">
                            <mat-icon>tag</mat-icon>
                            <span class="id-text">ID:</span>
                            <span class="id-value">#{{item.id}}</span>
                        </div>
                        <div class="card-code">{{item.ma_yc_xk}}</div>
                    </div>
                    <div class="card-badges">
                        <span class="status-badge" [ngClass]="getStatusClass(item.status)">
                            {{item.status ? 'Đã duyệt' : 'Chưa duyệt'}}
                        </span>
                        <span class="status-badge" [ngClass]="getScanClass(item.scan_status)">
                            {{item.scan_status ? 'Đã scan' : 'Chưa scan'}}
                        </span>
                    </div>
                </div>

                <!-- Transfer Route -->
                <div class="transfer-route">
                    <div class="warehouse-box">
                        <div class="warehouse-label">Từ kho</div>
                        <div class="warehouse-name">{{getWarehouseName(item.kho_xuat)}}</div>
                    </div>
                    <div class="arrow-icon">
                        <mat-icon>arrow_forward</mat-icon>
                    </div>
                    <div class="warehouse-box">
                        <div class="warehouse-label">Đến kho</div>
                        <div class="warehouse-name">{{getWarehouseName(item.xuat_toi)}}</div>
                    </div>
                </div>

                <!-- Card Content -->
                <div class="card-content">
                    <div class="info-row">
                        <span class="label">Đơn vị lĩnh</span>
                        <span class="value">{{item.don_vi_linh}}</span>
                    </div><div class="info-row">
                        <span class="label">Đơn vị nhận</span>
                        <span class="value">{{item.don_vi_nhan}}</span>
                    </div>

                    <div class="info-row">
                        <span class="label">Lý do</span>
                        <span class="value">{{item.ly_do_xuat_nhap}}</span>
                    </div>

                    <div class="info-row">
                        <span class="label">Ngày chứng từ</span>
                        <span class="value">{{item.ngay_chung_tu}}</span>
                    </div>

                    <div class="info-row">
                        <span class="label">Số chứng từ</span>
                        <span class="value">{{item.so_chung_tu}}</span>
                    </div>

                    <div class="info-row">
                        <span class="label">Số phiếu xuất</span>
                        <span class="value">{{item.so_phieu_xuat}}</span>
                    </div>

                    <div class="info-row">
                        <span class="label">Serial PGH</span>
                        <span class="value">{{item.series_PGH}}</span>
                    </div>
                </div>

                <!-- Card Actions -->
                <div class="card-actions">
                    <button mat-raised-button color="primary" (click)="onDetail(item)">
                        <mat-icon>playlist_add_check</mat-icon>
                        Xem chi tiết
                    </button>
                </div>
            </div>
        </div>
        <!-- Pagination -->
        <div class="pagination">
            <mat-form-field class="page-size-select" appearance="outline">
                <mat-select [(value)]="pageSize" (selectionChange)="onPageSizeChange()">
                    <mat-option [value]="10">10</mat-option>
                    <mat-option [value]="25">25</mat-option>
                    <mat-option [value]="50">50</mat-option>
                    <mat-option [value]="100">100</mat-option>
                </mat-select>
            </mat-form-field>


            <div class="pagination-buttons">
                <button *ngFor="let page of pageNumbers" mat-stroked-button [class.page-active]="currentPage === page"
                    (click)="onPageChange(page)">
                    {{ page }}
                </button>
            </div>

        </div>
    </mat-card>
</div>