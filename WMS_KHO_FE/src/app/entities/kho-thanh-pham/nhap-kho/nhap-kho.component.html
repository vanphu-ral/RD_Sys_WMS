<div class="nhapkho-container">
    <div class="nhapkho-header">
        <div class="header-title">
            <mat-icon class="title-icon">warehouse</mat-icon>
            <div>
                <h1>Quản lý nhập kho từ sản xuất</h1>
                <p class="subtitle">Warehouse management from production</p>
            </div>
        </div>
    </div>
    <!-- Content Card -->
    <mat-card class="nhapkho-card">
        <!-- Table Header -->
        <div class="table-header">
            <div class="table-title">
                <mat-icon>list</mat-icon>
                <span>Danh sách Nhập kho ({{totalItems}})</span>
            </div>
            <div class="table-actions">
                <button mat-raised-button (click)="onRefresh()" class="refresh-btn icon-only">
                    <mat-icon color="primary">sync</mat-icon>
                </button>
            </div>
        </div>

        <!-- Table -->
        <div class="table-container">
            <table mat-table [dataSource]="nhapKhoList" class="nhapkho-table">

                <!-- ID -->
                <!-- <ng-container matColumnDef="id">
                    <th mat-header-cell *matHeaderCellDef>ID</th>
                    <td mat-cell *matCellDef="let item">{{ item.id }}</td>
                </ng-container> -->
                <ng-container matColumnDef="stt">
                    <th mat-header-cell *matHeaderCellDef>STT</th>
                    <td mat-cell *matCellDef="let item; let i = index">
                        {{ i + 1 + (pageSize * (currentPage - 1)) }}
                    </td>
                </ng-container>

                <ng-container matColumnDef="inventory_name">
                    <th mat-header-cell *matHeaderCellDef>
                        <div>Tên sản phẩm</div>
                        <mat-form-field class="search-field" appearance="outline" style="width: 100%;">
                            <input matInput [(ngModel)]="filterValues.inventory_name" (keyup.enter)="applyFilter()" />
                        </mat-form-field>
                    </th>
                    <td mat-cell *matCellDef="let item">{{ item.inventory_name }}</td>
                </ng-container>

                <!-- Lot number -->
                <ng-container matColumnDef="lot_number">
                    <th mat-header-cell *matHeaderCellDef>
                        <div>Lot number</div>
                        <mat-form-field class="search-field" appearance="outline" style="width: 5rem;">
                            <input matInput [(ngModel)]="filterValues.lot_number" (keyup.enter)="applyFilter()" />
                        </mat-form-field>
                    </th>
                    <td mat-cell *matCellDef="let item">{{ item.lot_number }}</td>
                </ng-container>

                <!-- Mã đơn hàng -->
                <!-- <ng-container matColumnDef="order_id">
                    <th mat-header-cell *matHeaderCellDef>Mã đơn hàng</th>
                    <td mat-cell *matCellDef="let item">{{ item.order_id }}</td>
                </ng-container> -->

                <!-- Mã khách hàng -->
                <ng-container matColumnDef="client_id">
                    <th mat-header-cell *matHeaderCellDef>
                        <div>Khách hàng</div>
                        <mat-form-field class="search-field" appearance="outline" style="width: 5rem;">
                            <input matInput [(ngModel)]="filterValues.client_id" (keyup.enter)="applyFilter()" />
                        </mat-form-field>
                    </th>
                    <td mat-cell *matCellDef="let item">{{ item.client_id || '—' }}</td>
                </ng-container>
                <ng-container matColumnDef="number_of_pallet">
                    <th mat-header-cell *matHeaderCellDef>Số pallet</th>
                    <td mat-cell *matCellDef="let item">{{ item.number_of_pallet || '—' }}</td>
                </ng-container>
                <ng-container matColumnDef="number_of_box">
                    <th mat-header-cell *matHeaderCellDef>Số thùng</th>
                    <td mat-cell *matCellDef="let item">{{ item.number_of_box || '—' }}</td>
                </ng-container>

                <!-- Ngành hàng -->
                <ng-container matColumnDef="branch">
                    <th mat-header-cell *matHeaderCellDef>Ngành</th>
                    <td mat-cell *matCellDef="let item">{{ item.branch || '—' }}</td>
                </ng-container>

                <!-- Tổ sản xuất -->
                <ng-container matColumnDef="production_team">
                    <th mat-header-cell *matHeaderCellDef>Tổ sản xuất</th>
                    <td mat-cell *matCellDef="let item">{{ item.production_team || '—' }}</td>
                </ng-container>

                <!-- Số quyết định sản xuất -->
                <ng-container matColumnDef="production_decision_number">
                    <th mat-header-cell *matHeaderCellDef>QĐSX</th>
                    <td mat-cell *matCellDef="let item">{{ item.production_decision_number || '—' }}</td>
                </ng-container>

                <!-- Mã SKU -->
                <ng-container matColumnDef="item_no_sku">
                    <th mat-header-cell *matHeaderCellDef>No/SKU</th>
                    <td mat-cell *matCellDef="let item">{{ item.item_no_sku || '—' }}</td>
                </ng-container>

                <!-- Người phê duyệt -->
                <!-- <ng-container matColumnDef="approved_by">
                    <th mat-header-cell *matHeaderCellDef>Phê duyệt bởi</th>
                    <td mat-cell *matCellDef="let item">{{ item.approved_by || '—' }}</td>
                </ng-container> -->

                <!-- Ghi chú -->
                <ng-container matColumnDef="note">
                    <th mat-header-cell *matHeaderCellDef>Ghi chú</th>
                    <td mat-cell *matCellDef="let item">{{ item.note || '—' }}</td>
                </ng-container>

                <!-- Người cập nhật -->
                <ng-container matColumnDef="updated_by">
                    <th mat-header-cell *matHeaderCellDef>Người tạo</th>
                    <td mat-cell *matCellDef="let item">{{ item.updated_by || '—' }}</td>
                </ng-container>


                <!-- Mã WO -->
                <ng-container matColumnDef="wo_code">
                    <th mat-header-cell *matHeaderCellDef>
                        <div>Mã WO</div>
                        <mat-form-field class="search-field" appearance="outline" style="width: 5rem;">
                            <input matInput [(ngModel)]="filterValues.wo_code" (keyup.enter)="applyFilter()" />
                        </mat-form-field>
                    </th>
                    <td mat-cell *matCellDef="let item">{{ item.wo_code }}</td>
                </ng-container>
                <ng-container matColumnDef="po_number">
                    <th mat-header-cell *matHeaderCellDef>
                        <div>Mã PO</div>
                        <mat-form-field class="search-field" appearance="outline" style="width: 5rem;">
                            <input matInput [(ngModel)]="filterValues.po_number" (keyup.enter)="applyFilter()" />
                        </mat-form-field>
                    </th>
                    <td mat-cell *matCellDef="let item">{{ item.po_number || '—' }}</td>
                </ng-container>

                <!-- Ngày nhập -->
                <ng-container matColumnDef="updated_date">
                    <th mat-header-cell *matHeaderCellDef>Ngày nhập</th>
                    <td mat-cell *matCellDef="let item">{{ formatDate(item.updated_date) }}</td>
                </ng-container>

                <!-- Trạng thái -->
                <ng-container matColumnDef="status">
                    <th mat-header-cell *matHeaderCellDef>
                        <div>Trạng thái</div>
                        <mat-form-field class="search-field" appearance="outline">
                            <mat-select [(ngModel)]="filterValues.status" (selectionChange)="applyFilter()"
                                placeholder="Chọn trạng thái">
                                <mat-option value="">Tất cả</mat-option>
                                <mat-option value="Mới tạo">Mới tạo</mat-option>
                                <mat-option value="Chờ nhập">Chờ nhập</mat-option>
                                <mat-option value="Đã nhập">Đã nhập</mat-option>
                            </mat-select>
                        </mat-form-field>
                    </th>
                    <td mat-cell *matCellDef="let item">
                        <span class="status-badge" [ngClass]="getStatusClass(item.status)">
                            {{ item.status ? 'Đã nhập' : 'Chờ nhập' }}
                        </span>
                    </td>
                </ng-container>
                <ng-container matColumnDef="progress">
                    <th mat-header-cell *matHeaderCellDef>Tiến độ</th>
                    <td mat-cell *matCellDef="let item">
                        <div class="progress-cell">
                            <div class="progress-track" role="progressbar"
                                [attr.aria-valuenow]="computeProgressPercent(item)" [attr.aria-valuemin]="0"
                                [attr.aria-valuemax]="100">
                                <div class="progress-fill" [ngStyle]="{ width: computeProgressPercent(item) + '%' }">
                                </div>
                                <div class="progress-inner-text">
                                    {{ item.box_scan_progress ?? 0 }} / {{ item.number_of_box || 0 }}
                                </div>
                            </div>
                        </div>
                    </td>
                </ng-container>


                <!-- Options -->
                <ng-container matColumnDef="actions">
                    <th mat-header-cell *matHeaderCellDef class="text-center actions-column">Thao tác</th>
                    <td mat-cell *matCellDef="let item" class="text-center actions-column">
                        <div class="action-buttons-wrapper">
                            <button mat-icon-button class="action-btn approve-btn" (click)="onApprove(item)"
                                matTooltip="Phê duyệt">
                                <mat-icon>check_circle</mat-icon>
                            </button>
                            <button mat-icon-button class="action-btn detail-btn" (click)="onViewDetail(item)"
                                matTooltip="Xem chi tiết">
                                <mat-icon>visibility</mat-icon>
                            </button>
                            <!-- <button mat-icon-button class="action-btn scan-btn" (click)="onScan(item)"
                                matTooltip="Quét mã">
                                <mat-icon>qr_code_scanner</mat-icon>
                            </button> -->
                        </div>
                    </td>
                </ng-container>

                <!-- Header & Row -->
                <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                <tr mat-row *matRowDef="let row; columns: displayedColumns;" class="table-row"></tr>
            </table>

        </div>

        <!-- mobile -->

        <div class="mobile-filter-toggle">
            <button mat-stroked-button (click)="toggleMobileFilters()" class="filter-toggle-btn">
                <span>
                    <mat-icon>filter_list</mat-icon>
                    Bộ lọc
                </span>
                <mat-icon>{{showMobileFilters ? 'expand_less' : 'expand_more'}}</mat-icon>
            </button>
        </div>

        <!-- Mobile Filters Panel -->
        <div class="mobile-filters" [class.show]="showMobileFilters">
            <mat-form-field class="filter-field" appearance="outline">
                <mat-label>Tên kho</mat-label>
                <input matInput [(ngModel)]="filterValues.inventory_name" (keyup.enter)="applyFilter()" />
                <mat-icon matSuffix>search</mat-icon>
            </mat-form-field>

            <mat-form-field class="filter-field" appearance="outline">
                <mat-label>Lot number</mat-label>
                <input matInput [(ngModel)]="filterValues.lot_number" (keyup.enter)="applyFilter()" />
                <mat-icon matSuffix>search</mat-icon>
            </mat-form-field>

            <mat-form-field class="filter-field" appearance="outline">
                <mat-label>Mã WO</mat-label>
                <input matInput [(ngModel)]="filterValues.wo_code" (keyup.enter)="applyFilter()" />
                <mat-icon matSuffix>search</mat-icon>
            </mat-form-field>

            <mat-form-field class="filter-field" appearance="outline">
                <mat-label>Trạng thái</mat-label>
                <mat-select [(ngModel)]="filterValues.status" (selectionChange)="applyFilter()">
                    <mat-option value="">Tất cả</mat-option>
                    <mat-option value="Mới tạo">Mới tạo</mat-option>
                    <mat-option value="Chờ nhập">Chờ nhập</mat-option>
                    <mat-option value="Đã nhập">Đã nhập</mat-option>
                </mat-select>
            </mat-form-field>

            <div class="filter-actions">
                <button mat-button (click)="clearFilters()">
                    <mat-icon>clear</mat-icon>
                    Xóa
                </button>
                <button mat-raised-button color="primary" (click)="applyFilter(); toggleMobileFilters()">
                    <mat-icon>check</mat-icon>
                    Áp dụng
                </button>
            </div>
        </div>


        <!-- Mobile Card List -->
        <div class="mobile-nhapkho-list">
            <div class="mobile-nhapkho-card" *ngFor="let item of nhapKhoList; let i = index">
                <!-- Card Header -->
                <div class="card-header">
                    <div class="card-id-section">
                        <div class="card-id">
                            <mat-icon>tag</mat-icon>
                            #{{ (pageSize * (currentPage - 1)) + i + 1 }}
                        </div>
                        <div class="card-wo">WO: {{ item.wo_code }}</div>
                    </div>
                    <span class="status-badge" [ngClass]="getStatusClass(item.status)">
                        {{ item.status ? 'Đã nhập' : 'Chờ nhập' }}
                    </span>
                </div>

                <!-- Card Content -->
                <div class="card-content">
                    <!-- Tên sản phẩm -->
                    <div class="info-row highlight">
                        <span class="info-label">
                            <mat-icon>inventory</mat-icon>
                            Tên sản phẩm
                        </span>
                        <span class="info-value">{{ item.inventory_name }}</span>
                    </div>

                    <!-- Lot Number -->
                    <div class="info-row">
                        <span class="info-label">
                            <mat-icon>numbers</mat-icon>
                            Lot number
                        </span>
                        <span class="info-value">{{ item.lot_number }}</span>
                    </div>

                    <!-- Khách hàng -->
                    <div class="info-row">
                        <span class="info-label">
                            <mat-icon>business</mat-icon>
                            Khách hàng
                        </span>
                        <span class="info-value">{{ item.client_id || '—' }}</span>
                    </div>

                    <!-- Số lượng Grid -->
                    <div class="quantity-grid">
                        <div class="qty-item pallet">
                            <mat-icon>inventory_2</mat-icon>
                            <div class="qty-info">
                                <span class="qty-label">Số Pallet</span>
                                <span class="qty-value">{{ item.number_of_pallet || '—' }}</span>
                            </div>
                        </div>
                        <div class="qty-item box">
                            <mat-icon>widgets</mat-icon>
                            <div class="qty-info">
                                <span class="qty-label">Số Thùng</span>
                                <span class="qty-value">{{ item.number_of_box || '—' }}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Tiến độ -->
                    <div class="info-row progress-row">
                        <span class="info-label">
                            <mat-icon>analytics</mat-icon>
                            Tiến độ scan
                        </span>
                        <div class="progress-wrapper">
                            <div class="progress-track" role="progressbar"
                                [attr.aria-valuenow]="computeProgressPercent(item)" 
                                [attr.aria-valuemin]="0"
                                [attr.aria-valuemax]="100">
                                <div class="progress-fill" 
                                    [ngStyle]="{ width: computeProgressPercent(item) + '%' }">
                                </div>
                                <div class="progress-inner-text">
                                    {{ item.box_scan_progress ?? 0 }} / {{ item.number_of_box || 0 }}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Ngành -->
                    <!-- <div class="info-row">
                        <span class="info-label">
                            <mat-icon>category</mat-icon>
                            Ngành
                        </span>
                        <span class="info-value">{{ item.branch || '—' }}</span>
                    </div> -->

                    <!-- Tổ sản xuất -->
                    <!-- <div class="info-row">
                        <span class="info-label">
                            <mat-icon>groups</mat-icon>
                            Tổ sản xuất
                        </span>
                        <span class="info-value">{{ item.production_team || '—' }}</span>
                    </div> -->

                    <!-- QĐSX -->
                    <!-- <div class="info-row">
                        <span class="info-label">
                            <mat-icon>description</mat-icon>
                            QĐ SX
                        </span>
                        <span class="info-value">{{ item.production_decision_number || '—' }}</span>
                    </div> -->

                    <!-- Item No/SKU -->
                    <!-- <div class="info-row">
                        <span class="info-label">
                            <mat-icon>qr_code</mat-icon>
                            Item No/SKU
                        </span>
                        <span class="info-value">{{ item.item_no_sku || '—' }}</span>
                    </div> -->

                    <!-- Người tạo -->
                    <div class="info-row">
                        <span class="info-label">
                            <mat-icon>person</mat-icon>
                            Người tạo
                        </span>
                        <span class="info-value">{{ item.updated_by || '—' }}</span>
                    </div>

                    <!-- Ngày nhập -->
                    <div class="info-row">
                        <span class="info-label">
                            <mat-icon>calendar_today</mat-icon>
                            Ngày nhập
                        </span>
                        <span class="info-value">{{ formatDate(item.updated_date) }}</span>
                    </div>

                    <!-- Ghi chú -->
                    <div class="info-row note-row" *ngIf="item.note">
                        <span class="info-label">
                            <mat-icon>notes</mat-icon>
                            Ghi chú
                        </span>
                        <span class="info-value">{{ item.note }}</span>
                    </div>
                </div>

                <!-- Card Actions -->
                <div class="card-actions">
                    <button mat-raised-button class="approve-btn" (click)="onApprove(item)">
                        <mat-icon>check_circle</mat-icon>
                        Phê duyệt
                    </button>
                    <button mat-stroked-button class="detail-btn" (click)="onViewDetail(item)">
                        <mat-icon>visibility</mat-icon>
                        Chi tiết
                    </button>
                </div>
            </div>

            <!-- Empty State -->
            <div class="empty-state" *ngIf="nhapKhoList.length === 0">
                <mat-icon>inbox</mat-icon>
                <p>Chưa có dữ liệu nhập kho</p>
            </div>
        </div>


        <!-- Pagination -->
        <div class="pagination">
            <mat-form-field class="page-size-select" appearance="outline">
                <mat-select [(value)]="pageSize" (selectionChange)="onPageSizeChange()">
                    <mat-option [value]="10">10</mat-option>
                    <mat-option [value]="25">25</mat-option>
                    <mat-option [value]="50">50</mat-option>
                    <mat-option [value]="100">100</mat-option>
                </mat-select>
            </mat-form-field>

            <div class="pagination-buttons">
                <button *ngFor="let page of [].constructor(totalPages); let i = index" mat-button
                    [class.page-active]="currentPage === i + 1" (click)="onPageChange(i + 1)">
                    {{ i + 1 }}
                </button>
            </div>
        </div>

    </mat-card>

</div>